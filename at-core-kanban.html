<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-core-style-classes/at-core-style-classes.html" />
<link rel="import" href="../at-core-spinner/at-core-spinner.html" />
<link rel="import" href="../at-carbon-message/at-carbon-message.html" />

<dom-module id="at-core-kanban">
  <template>
    <style include="at-core-style-classes">
      :host {
        display: block;
        box-sizing: border-box;

        border: 1px solid purple;
        padding: 8px;
      }
    </style>

    <at-core-spinner id="coreSpinner"></at-core-spinner>
    <at-carbon-message id="carbonMessage" type="info"></at-carbon-message>

    <div id="columnContainer" hidden>at-core-kanban works!</div>
  </template>
</dom-module>
<script>
  Polymer({
    is: "at-core-kanban",
    properties: {

      columns: {
        type: Array,
        value: function() {
          return [];
        },
        xgridcols: "12",
        schema: {
          properties: {
            id: {
              type: String,
              value: ''
            },
            title: {
              type: String,
              value: ''
            }
          }
        }
      },

      columnPath: {
        type: String,
        value: 'prio'
      },

      items: {
        type: Array,
        value: function() {
          return [];
        },
        xgridcols: "12",
        schema: {
          properties: {
            id: {
              type: String,
              value: ''
            },
            title: {
              type: String,
              value: ''
            },
            prio: {
              type: String,
              value: ''
            }
          }
        }
      },

      layout: {
        type: String,
        value: "list",
        notify: true,
        xtype: "enum",
        available: "card,list"
      },

      itemComponent: {
        type: String,
        value: "",
        notify: true
      },

      cardWidth: {
        type: String,
        value: "320",
        notify: true
      },

      cardHeight: {
        type: String,
        value: "",
        notify: true
      },

      view: {
        type: String,
        value: "",
        notify: true,
        xtype: "code",
        mode: "carbon",
        xgridcols: "12"
      },

      indicator: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },

      height: {
        type: String,
        value: "120px"
      },

      emptyList: {
        type: String,
        value: "No data found"
      }
    },

    $meta: [{
      title: "Kanban board",
      type: "element",
      xtype: "at-core-kanban",
      invisible: true
    }],

    observers: [
      '_initialize(columns.*, columnPath, items.*, layout, itemComponent, cardWidth, cardHeight, view, indicator, height, emptyList)'
    ],

    ready: function () { },

    _showSpinner: function() {
      this.$.coreSpinner.removeAttribute('hidden');
    },

    _hideSpinner: function() {
      this.$.coreSpinner.setAttribute('hidden', true);
    },

    _showMessage: function(text) {
      this.$.carbonMessage.html = text;
    },

    _clearMessage: function() {
      this.$.carbonMessage.html = '';
    },

    _initialize: function(columnsSplices, columnPath, itemsSplices, layout, itemComponent, cardWidth, cardHeight, view, indicator, height, emptyList) {

      this._showSpinner();
      this._clearMessage();

      var self = this;
      this.debounce('debounce-internal-initialize', function() {
        self._internalInitialize(columnsSplices, columnPath, itemsSplices, layout, itemComponent, cardWidth, cardHeight, view, indicator, height, emptyList);
      }, 100);
    },

    _internalInitialize: function(columnsSplices, columnPath, itemsSplices, layout, itemComponent, cardWidth, cardHeight, view, indicator, height, emptyList) {

      var columns = columnsSplices.value;
      var items = itemsSplices.value;

      if (!this._isArray(columns) || !columns.length) {
        this._hideSpinner();
        this._showMessage(emptyList);
        console.log("Columns property value of " + JSON.stringify(columns) + " is invalid or empty.");
        return;
      }

      if (!this._isArray(items) || !items.length) {
        this._hideSpinner();
        this._showMessage(emptyList);
        console.log("Items property value of " + JSON.stringify(items) + " is invalid or empty.");
        return;
      }

      var viewPresent = this._isString(view) && view.length;
      var itemComponentPresent = this._isString(itemComponent) && itemComponent.length;
      if (!viewPresent && !itemComponentPresent) {
        this._hideSpinner();
        this._showMessage("Please provide .view or .itemComponent property.");
        return;
      }

      // if itemComponent is present and view is not present, use itemComponent
      // if itemComponent is not present and view is present, use at-core-view
      // if itemComponent is present and view is present, use itemComponent
      var componentPath = itemComponentPresent ? itemComponent : "at-core-view";

      // extract elementName from componentPath
      // if itemComponent is not present use componentPath as element name because componentPath is set to at-core-view
      // if itemComponent is present extract elementName from componentPath
      var elementName = itemComponentPresent ?
        this._computeElementNameFromComponentPath(componentPath) : componentPath;

      // check if elementName already exists in polymer.telemetry.registrations
      var registrations = Polymer.telemetry.registrations;
      var registrationsLength = registrations.length;
      var found = false;
      for (var i = 0; i < registrationsLength && !found; i++) {
        var reg = registrations[i];
        found = reg.is === elementName;
      }

      // if exists do the rendering
      if (found) {
        this._render(columns, columnPath, items, layout, elementName, cardWidth, cardHeight, view, height);

      } else {
        // if not compute import url and use importHref to load
        var self = this;
        var importUrl = this._computeImportUrlFromComponentPath(componentPath);
        this.importHref(
          importUrl,
          function() { // success callback
            self._render(columns, columnPath, items, layout, elementName, cardWidth, cardHeight, view, height);
          },
          function() { // error callback
            Polymer.signal("busy-end");
            var restart = confirm(window.location.href + "\n\nERROR: failed to load list item " + this.itemComponent);

            if (restart) {
              location.hash = ""; // clear current hash
              location.reload(); // go to start app by reloading without hash
            }
          },
          true // import will be async
        );
      }
    },

    _render: function(columns, columnPath, items, layout, elementName, cardWidth, cardHeight, view, height) {

      this._hideSpinner();
      this._clearMessage();
    },

    //
    // Helper functions
    //
    _isArray: function(obj) {
      return Object.prototype.toString.apply(obj) === "[object Array]";
    },

    _isString: function(obj) {
      return Object.prototype.toString.apply(obj) === "[object String]";
    },

    _computeElementNameFromComponentPath: function(componentPath) {
      var eltName = '';

      var resolve = { namePrefix: "" };
      this.fire("resolve-name-prefix", resolve);
      var prefix = resolve.namePrefix;

      // if componentPath is default.view and prefix is not empty return prefix as element name
      if (componentPath === "default.view" && prefix.length > 0) {
        return prefix.length > 0 ? prefix : eltName;
      }

      if (componentPath.indexOf(".card") > 0) {
        // if componentPath is "default.card" reduce to "card"
        // if componentPath is not "default.card" it remains as is
        eltName = componentPath.replace("default.", "");

        // if componentPath is "foo.card" it should become "foo-card"
        eltName = eltName.replace(".", "-");

        var nameParts = [ prefix, "-", eltName ];
        eltName = nameParts.join("");
        return eltName;

      } else {
        // if componentPath is not default.view and doesn't end with .card it can be
        // 1) item-component (from local folder)
        // 2) component-name/item-component (from other component)
        if (componentPath.indexOf("/") === -1) {
          // this is from local folder
          return componentPath;

        } else {
          var pathParts = componentPath.split("/");
          eltName = pathParts[1];
          return eltName;
        }
      }
    },

    _computeImportUrlFromComponentPath: function(componentPath) {

    }

  });
</script>
